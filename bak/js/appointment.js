    const translations = {
        en: {
            "nav-home": "Home",
            "nav-gallery": "Gallery",
            "nav-contact": "Contact Us",
            "main-title": "Book Your Appointment",
            "form-title": "Enter Your Details",
            "summary-title": "Booking Summary",
            "confirm-button": "Confirm Booking",
            "book-now-button": "Book Now",
            "footer-rights": "© 2024 Azorpub. All rights reserved.",
            "footer-developed": "Developed by Azorpub Team",
            "selected-date": "Selected Date:",
            "please-enter-details": "Please enter valid details.",
            "booking-confirmed": "Booking Confirmed!",
            "privacy-note": "Your name and email will only be used to send you details about your appointment. We value your privacy.",
            // "booking-success": "Booking Submitted Successfully!",
            "appointment-pending": "Your appointment is pending.",
            "appointment-missed": "You missed your appointment.",
            "error-loading-times": "Error loading booked times.",
            "failed-booking": "Failed to book the appointment.",
            "confirm-edit": "Confirm Appointment Changes",
            "edit-title": "Edit Your Appointment",

            "status-title-pending": "Your appointment is pending.",
            "status-message-pending": "Please confirm the appointment before making any changes.",
            "status-title-missed": "You missed your appointment.",
            "status-message-missed": "You can reschedule your appointment to select a new date.",
            "status-title-confirmed": "Edit Your Appointment",
            "status-message-confirmed": "You can edit the details of your appointment.",
            "status-title-cancelled": "Your appointment has been cancelled.",
            "status-message-cancelled": "You can reschedule your appointment to select a new date.",

            "fill-fields": "Please fill in all required fields (name and email).",
            "select-date-time": "Please select a date and time for your appointment.",
            "booking-success": "Booking Submitted Successfully!",
            "update-success": "Your appointment has been updated successfully.",
            "email-exists": "Email already has an appointment.",
            "failed-book": "Failed to book the appointment. Please try again.",
            "failed-update": "Failed to update the appointment. Please try again.",
            "booking-confirmation-email": "A confirmation email has been sent to your email address. Please check your inbox and follow the instructions to confirm your appointment.",
            "check-spam-folder": "If you don't see the email, please check your spam or junk folder.",
            "thank-you": "Thank you for choosing Azorpub!"


        },
        ar: {
            "nav-home": "الرئيسية",
            "nav-gallery": "المعرض",
            "nav-contact": "اتصل بنا",
            "main-title": "احجز موعدك",
            "form-title": "أدخل بياناتك",
            "summary-title": "ملخص الحجز",
            "confirm-button": "تأكيد الحجز",
            "book-now-button": "احجز الآن",
            "footer-rights": "© 2024 Azorpub. جميع الحقوق محفوظة.",
            "footer-developed": "تم التطوير بواسطة فريق Azorpub",
            "selected-date": "التاريخ المحدد:",
            "please-enter-details": "يرجى إدخال بيانات صحيحة.",
            "booking-confirmed": "تم تأكيد الحجز!",
            "privacy-note": "لن يتم استخدام اسمك أو بريدك الإلكتروني إلا لإرسال تفاصيل موعدك. نحن نحترم خصوصيتك.",
            "booking-success": "تم إرسال الحجز بنجاح!",
            "appointment-pending": "موعدك معلق.",
            "appointment-missed": "لقد فات موعدك.",
            "error-loading-times": "حدث خطأ أثناء تحميل الأوقات المحجوزة.",
            "failed-booking": "فشل في حجز الموعد.",
            "confirm-edit": "تأكيد تعديل الحجز",
            "edit-title": "تعديل موعدك",

            "status-title-pending": "موعدك معلق.",
            "status-message-pending": "يرجى تأكيد الموعد قبل إجراء أي تغييرات.",
            "status-title-missed": "لقد فات موعدك.",
            "status-message-missed": "يمكنك إعادة جدولة الموعد لاختيار تاريخ جديد.",
            "status-title-confirmed": "تعديل موعدك",
            "status-message-confirmed": "يمكنك تعديل تفاصيل موعدك.",
            "status-title-cancelled": "تم إلغاء الموعد.",
            "status-message-cancelled": "يمكنك إعادة جدولة الموعد لاختيار تاريخ جديد.",

            "fill-fields": "يرجى إدخال جميع الحقول المطلوبة (الاسم والبريد الإلكتروني).",
            "select-date-time": "يرجى اختيار التاريخ والوقت لموعدك.",
            "booking-success": "تم إرسال الحجز بنجاح!",
            "update-success": "تم تحديث الموعد بنجاح.",
            "email-exists": "البريد الإلكتروني لديه موعد بالفعل.",
            "failed-book": "فشل في حجز الموعد. يرجى المحاولة مرة أخرى.",
            "failed-update": "فشل في تحديث الموعد. يرجى المحاولة مرة أخرى.",
            "booking-confirmation-email": "تم إرسال بريد إلكتروني لتأكيد الحجز. يرجى التحقق من بريدك الإلكتروني واتباع التعليمات لتأكيد موعدك.",
            "check-spam-folder": "إذا لم تجد البريد الإلكتروني، يرجى التحقق من مجلد الرسائل غير المرغوب فيها.",
            "thank-you": "شكرًا لاختيارك Azorpub!"
        },
        nl: {
            "nav-home": "Startpagina",
            "nav-gallery": "Galerij",
            "nav-contact": "Contacteer ons",
            "main-title": "Boek uw afspraak",
            "form-title": "Vul uw gegevens in",
            "summary-title": "Samenvatting van de boeking",
            "confirm-button": "Bevestig afspraak",
            "book-now-button": "Boek nu",
            "footer-rights": "© 2024 Azorpub. Alle rechten voorbehouden.",
            "footer-developed": "Ontwikkeld door Azorpub Team",
            "selected-date": "Geselecteerde datum:",
            "please-enter-details": "Voer geldige gegevens in.",
            "booking-confirmed": "Boeking bevestigd!",
            "privacy-note": "Uw naam en e-mailadres worden alleen gebruikt om u details over uw afspraak te sturen. Wij hechten waarde aan uw privacy.",
            "booking-success": "Boeking succesvol ingediend!",
            "appointment-pending": "Uw afspraak is in afwachting.",
            "appointment-missed": "U heeft uw afspraak gemist.",
            "error-loading-times": "Fout bij het laden van geboekte tijden.",
            "failed-booking": "Boeking mislukt.",
            "confirm-edit": "Bevestig wijziging van afspraak",
            "edit-title": "Wijzig uw afspraak",

            "status-title-pending": "Uw afspraak is in afwachting.",
            "status-message-pending": "Bevestig de afspraak voordat u wijzigingen aanbrengt.",
            "status-title-missed": "U heeft uw afspraak gemist.",
            "status-message-missed": "U kunt uw afspraak opnieuw plannen om een nieuwe datum te selecteren.",
            "status-title-confirmed": "Wijzig uw afspraak",
            "status-message-confirmed": "U kunt de details van uw afspraak bewerken.",
            "status-title-cancelled": "Uw afspraak is geannuleerd.",
            "status-message-cancelled": "U kunt uw afspraak opnieuw plannen om een nieuwe datum te selecteren.",

            "fill-fields": "Vul alle verplichte velden in (naam en e-mail).",
            "select-date-time": "Selecteer een datum en tijd voor uw afspraak.",
            "booking-success": "Reservering succesvol ingediend!",
            "update-success": "Uw afspraak is succesvol bijgewerkt.",
            "email-exists": "E-mailadres heeft al een afspraak.",
            "failed-book": "Reservering mislukt. Probeer het opnieuw.",
            "failed-update": "Bijwerken van afspraak mislukt. Probeer het opnieuw.",
            "booking-confirmation-email": "Een bevestigingsmail is verzonden naar uw e-mailadres. Controleer uw inbox en volg de instructies om uw afspraak te bevestigen.",
            "check-spam-folder": "Als u de e-mail niet ziet, controleer dan uw spam- of junkmap.",
            "thank-you": "Bedankt voor het kiezen van Azorpub!"

        }

    };


    document.addEventListener('DOMContentLoaded', function() {
        // التحقق من تفضيل المستخدم الحالي
        const userPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        // تعيين الثيم بناءً على التفضيل
        if (userPrefersDark) {
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
        }
        // التحديث عند تغيير التفضيل
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const newTheme = e.matches ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
        });


        const calendar = document.getElementById('calendar');
        const timeSlots = document.getElementById('time-slots');
        const slotsContainer = document.getElementById('slots-container');
        const bookingForm = document.getElementById('booking-form');
        const selectedDate = document.getElementById('selected-date');
        const bookingMessage = document.getElementById('booking-message');
        const emailExistsMessage = document.getElementById('email-exists-message');

        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        let currentMonth = ''; // لتتبع الشهر الحالي
        // تعيين اللغة المحفوظة أو الافتراضية
        const langSelector = document.getElementById('lang-selector');
        const currentLang = localStorage.getItem('language') || 'en';
        langSelector.value = currentLang;
        setLanguage(currentLang);
        // تغيير اللغة عند اختيار جديد
        langSelector.addEventListener('change', (e) => {
            const selectedLang = e.target.value;
            localStorage.setItem('language', selectedLang); // حفظ اللغة
            setLanguage(selectedLang); // تغيير اللغة ديناميكيًا
            updateConfirmedTexts(selectedLang); // تحديث النصوص الجديدة
            // تحديث النصوص داخل الحالة الحالية
            if (appointment) {
                handleAppointmentStatus(appointment);
            }
        });
        // إنشاء التقويم
        for (let i = 0; i < 30; i++) {
            const date = new Date(today.getFullYear(), today.getMonth(), today.getDate() + i);
            const dayName = dayNames[date.getDay()];
            const dayNumber = date.getDate();
            const monthName = date.toLocaleString('default', {
                month: 'long'
            });

            // إذا تغير الشهر، أضف حاوية جديدة للشهر
            if (monthName !== currentMonth) {
                currentMonth = monthName;

                // إنشاء حاوية الشهر
                monthContainer = document.createElement('div');
                monthContainer.className = 'month-container';

                // إضافة اسم الشهر
                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.innerText = monthName;

                // حاوية الأيام
                const daysGrid = document.createElement('div');
                daysGrid.className = 'days-grid';

                // ربط العناصر معًا
                monthContainer.appendChild(monthHeader);
                monthContainer.appendChild(daysGrid);
                calendar.appendChild(monthContainer);
            }

            // إنشاء اليوم وإضافته إلى شبكة الأيام
            const day = document.createElement('div');
            day.className = 'day';
            day.innerText = `${dayNumber} (${dayName})`;

            if (dayName === 'Sun') {
                day.classList.add('unavailable'); // الأيام غير المتاحة
            } else {
                // console.log(`Day Selected: ${dayNumber} (${dayName})`);
                day.addEventListener('click', () => selectDay(dayNumber, dayName));
            }

            // إضافة اليوم إلى شبكة الأيام داخل الشهر المناسب
            const currentDaysGrid = monthContainer.querySelector('.days-grid');
            currentDaysGrid.appendChild(day);
        }

        function selectDay(dayNumber, dayName) {
            // إزالة التحديد السابق
            document.querySelectorAll('.day').forEach(el => el.classList.remove('selected'));

            // البحث عن اليوم المناسب يدويًا
            const days = document.querySelectorAll('.day');
            let selectedDay = null;

            days.forEach(day => {
                if (day.innerText === `${dayNumber} (${dayName})`) {
                    selectedDay = day;
                }
            });

            if (selectedDay) {
                selectedDay.classList.add('selected');
            }

            // استخراج الشهر والسنة من الحاوية
            const parentMonthContainer = selectedDay.closest('.month-container'); // حاوية الشهر
            const monthName = parentMonthContainer.querySelector('.month-header').innerText; // اسم الشهر
            const today = new Date();
            const monthIndex = new Date(`${monthName} 1, ${today.getFullYear()}`).getMonth(); // تحويل اسم الشهر إلى رقمه
            const year = today.getFullYear();

            // إنشاء التاريخ الكامل
            const fullDate = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
            selectedDate.innerText = `${dayName}, ${fullDate}`;

            // عرض الأوقات بناءً على اليوم المحدد
            timeSlots.style.display = 'block';
            slotsContainer.innerHTML = '';
            bookingForm.style.display = 'none';

            const times = dayName === 'Sat' ? ['10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM'] : ['10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM', '5:00 PM'];

            times.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.innerText = time;
                slot.addEventListener('click', () => selectTime(slot));
                slotsContainer.appendChild(slot);
            });

            // تحميل الأوقات المحجوزة
            loadBookedTimes(fullDate);
        }
        // دالة لتحويل الوقت إلى تنسيق 12 ساعة (يتطابق مع الوقت المحجوز في PHP)
        function convertTo12HourFormat(time24) {
            const [hours, minutes] = time24.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const adjustedHours = hours % 12 || 12; // تحويل الساعة 0 إلى 12
            return `${adjustedHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        function loadBookedTimes(date) {
            fetch('process_booking.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_booked_times',
                        date: date,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const times = ['10:00 AM', '11:00 AM', '12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM', '5:00 PM'];
                        slotsContainer.innerHTML = ''; // إعادة تعيين قائمة الساعات

                        // تحويل الأوقات المحجوزة إلى تنسيق 12 ساعة
                        const bookedTimes12Hour = data.bookedTimes.map(convertTo12HourFormat);

                        times.forEach(time => {
                            const slot = document.createElement('div');
                            slot.className = 'slot';
                            slot.innerText = time;

                            // تحقق إذا كان الوقت محجوزًا
                            if (bookedTimes12Hour.includes(time)) {
                                slot.classList.add('unavailable');
                                slot.style.pointerEvents = 'none'; // منع التفاعل مع الوقت المحجوز
                            } else {
                                slot.addEventListener('click', () => selectTime(slot));
                            }

                            slotsContainer.appendChild(slot);
                        });
                    } else {
                        alert('Error loading booked times.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function selectTime(slot) {
            document.querySelectorAll('.slot').forEach(el => el.classList.remove('selected'));
            slot.classList.add('selected');
            bookingForm.style.display = 'block';
        }

        // التحقق من وجود الموعد للبريد الإلكتروني
        document.getElementById('form-details').onsubmit = function(e) {
            e.preventDefault();
            // تعريف اللغة
            const lang = localStorage.getItem('language') || 'en';
            // استرجاع الحقول من النموذج
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const selectedDateElement = document.getElementById('selected-date');
            const selectedTimeElement = document.querySelector('.slot.selected');

            // استخراج التاريخ المحدد أو القيمة الافتراضية
            let selectedDate = selectedDateElement && selectedDateElement.innerText ?
                selectedDateElement.innerText.split(', ')[1] // استخراج التاريخ فقط (بدون اسم اليوم)
                :
                (appointmentCode ? appointment.DATE : null); // استخدم التاريخ الافتراضي في حالة التعديل

            // تحويل التاريخ إلى صيغة YYYY-MM-DD إذا لم يكن بالفعل بهذه الصيغة
            if (selectedDate) {
                const dateObject = new Date(selectedDate);
                selectedDate = dateObject.toISOString().split('T')[0]; // تحويل إلى YYYY-MM-DD
            }

            const selectedTime = selectedTimeElement ?
                selectedTimeElement.innerText :
                (appointmentCode ? convertTo12HourFormat(appointment.TIME) : null); // استخدم الوقت الافتراضي في حالة التعديل

            // التحقق من المدخلات
            if (!name || !email) {
                alert(translations[lang]["fill-fields"]);
                return;
            }

            // إذا كنا في وضع الإضافة، يجب التحقق من اختيار التاريخ والوقت
            if (!appointmentCode && (!selectedDate || !selectedTime)) {
                alert(translations[lang]["select-date-time"]);
                return;
            }

            // تحويل الوقت إلى صيغة 24 ساعة
            const timeIn24HourFormat = selectedTime ? convertTo24HourFormat(selectedTime) : null;

            // إرسال الطلب إلى الخادم
            const action = appointmentCode ? 'update' : 'book';

            fetch('process_booking.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        name: name,
                        email: email,
                        date: selectedDate, // التاريخ بصيغة YYYY-MM-DD
                        time: timeIn24HourFormat, // الوقت بتنسيق 24 ساعة
                        code: appointmentCode, // يُرسل فقط عند التعديل
                    }),
                })
                .then((response) => response.json())
                .then((data) => {
                    const successMessageElement = document.getElementById('booking-success-message');

                    if (data.success) {
                        if (action === 'book') {
                            emailExistsMessage.style.display = 'none';
                            successMessageElement.style.display = 'block';
                            successMessageElement.innerHTML = `
                                   <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; text-align: center; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; margin-top: 20px;">
                                        <h2 style="color: #007bff; font-size: 24px;">${translations[lang]["booking-success"]}</h2>
                                        <p style="font-size: 16px; margin: 15px 0;">${translations[lang]["booking-confirmation-email"]}</p>
                                        <p style="font-size: 14px; color: #555;">${translations[lang]["check-spam-folder"]}</p>
                                        <p style="font-size: 14px; color: #333; margin-top: 10px;">${translations[lang]["thank-you"]}</p>
                                    </div>
                                `;

                        } else if (action === 'update') {
                            emailExistsMessage.style.display = 'none';
                            successMessageElement.style.display = 'block';
                            successMessageElement.innerHTML = `
                                <div style="font-family: Arial, sans-serif; color: #333; text-align: center; padding: 10px; margin-top: 10px; background-color: #f0f0f0; border-radius: 5px;">
                                    <p style="font-size: 16px; color: #007bff;">${translations[lang]["update-success"]}</p>
                                </div>
                                `;
                        }
                    } else if (data.message === 'Email already has an appointment') {
                        emailExistsMessage.style.display = 'block'; // عرض رسالة وجود الموعد
                        bookingMessage.style.display = 'none'; // إخفاء أي رسائل أخرى
                    } else {
                        successMessageElement.style.display = 'block';
                        successMessageElement.innerHTML = `
                             <div style="color: red; text-align: center;">
                                <p>${translations[lang][
                                    action === 'book' ? "failed-book" : "failed-update"
                                ]}</p>
                            </div>
                        `;
                    }
                })
                .catch((error) => {
                    console.error("Error during booking confirmation:", error);
                });
        };

        document.getElementById('forgot-appointment').addEventListener('click', function() {
            const email = document.getElementById('email').value.trim();

            if (!email) {
                alert("Please enter your email to retrieve your appointment.");
                return;
            }

            fetch('process_booking.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'resend_appointment_details',
                        email: email
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Appointment details have been sent to your email.");
                    } else {
                        alert(data.message || "No appointment found for this email.");
                    }
                })
                .catch(error => {
                    console.error("Error sending appointment details:", error);
                    alert("An error occurred. Please try again later.");
                });
        });

        function convertTo24HourFormat(time12) {
            const [time, modifier] = time12.split(' ');
            let [hours, minutes] = time.split(':');
            if (modifier === 'PM' && hours !== '12') {
                hours = parseInt(hours, 10) + 12;
            }
            if (modifier === 'AM' && hours === '12') {
                hours = '00';
            }
            return `${hours}:${minutes}:00`;
        }
        // التحقق إذا كان هناك كود في الرابط
        if (appointmentCode) {
            fetchAppointmentDetails(appointmentCode);
        } else {
            const statusMessageContainer = document.getElementById('statusMessage-Container');
            statusMessageContainer.style.display = 'none';
        }
    });

    function setLanguage(lang) {
        document.querySelectorAll('[data-lang]').forEach((element) => {
            const key = element.getAttribute('data-lang');
            if (translations[lang][key]) {
                element.innerText = translations[lang][key];
            }
        });

        // تحديث النصوص داخل الحقول (placeholders)
        const placeholders = {
            en: { name: "Your Name", email: "Your Email" },
            ar: { name: "اسمك", email: "بريدك الإلكتروني" },
            nl: {
                name: "Uw Naam",
                email: "Uw E-mailadres"
            }

        };
        document.getElementById('name').placeholder = placeholders[lang].name;
        document.getElementById('email').placeholder = placeholders[lang].email;

        // تغيير اتجاه النص إذا كانت اللغة العربية
        document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
        // حفظ اللغة في localStorage
        localStorage.setItem('language', lang);

    }


    // استخراج الكود من الرابط
    const urlParams = new URLSearchParams(window.location.search);
    const appointmentCode = urlParams.get('code');


    let appointment = null; // تعريف متغير عالمي لتخزين تفاصيل الموعد
    function fetchAppointmentDetails(code) {
        fetch('process_booking.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'fetch_appointment',
                    code: code,
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("Server response:", data); // عرض الرد من الخادم

                if (data.success) {
                    appointment = data.appointment; // تخزين تفاصيل الموعد في المتغير
                    handleAppointmentStatus(data.appointment);
                } else {
                    alert(data.message || "Failed to fetch appointment details.");
                }
            })
            .catch(error => {
                console.error("Error fetching appointment details:", error);
            });
    }

    function handleAppointmentStatus(appointment) {

        const lang = localStorage.getItem('language') || 'en';

        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        const renewBtn = document.getElementById('renew-btn');
        const calendarContainer = document.getElementById('calendar-container'); // التقويم
        const timeSlots = document.getElementById('time-slots'); // الأوقات
        const formFields = document.getElementById('form-details'); // حقول الاسم والإيميل
        const bookingForm = document.getElementById('booking-form'); // النموذج
        console.log("Appointment Code:", appointment.STATUS);
        if (appointment.STATUS === 'Pending') {
            statusTitle.innerText = translations[lang]["status-title-pending"];
            statusMessage.innerText = translations[lang]["status-message-pending"];
        } else if (appointment.STATUS === 'Missed') {
            statusTitle.innerText = translations[lang]["status-title-missed"];
            statusMessage.innerText = translations[lang]["status-message-missed"];
            renewBtn.style.display = 'inline-block'; // عرض زر التجديد
            formFields.style.display = 'block'; // عرض حقول الاسم والإيميل فقط
            populateAppointmentForm(appointment, false); // لا تعبئة لتفاصيل الموعد
        } else if (appointment.STATUS === 'Confirmed') {
            statusTitle.innerText = translations[lang]["status-title-confirmed"];
            statusMessage.innerText = translations[lang]["status-message-confirmed"];
            calendarContainer.style.display = 'block'; // عرض التقويم
            timeSlots.style.display = 'block'; // عرض أوقات الحجز
            bookingForm.style.display = 'block'; // عرض النموذج
            populateAppointmentForm(appointment, true); // تعبئة التفاصيل بالكامل
        } else if (appointment.STATUS === 'Cancelled') {
            statusTitle.innerText = translations[lang]["status-title-cancelled"];
            statusMessage.innerText = translations[lang]["status-message-cancelled"];
            renewBtn.style.display = 'inline-block'; // عرض زر التجديد
            formFields.style.display = 'block'; // عرض حقول الاسم والإيميل فقط
            populateAppointmentForm(appointment, false); // لا تعبئة لتفاصيل الموعد
        }
        // تحديث النصوص بناءً على السياق واللغة
        setLanguage(lang)
    }

    function updateTexts(lang) {
        document.querySelectorAll('[data-lang]').forEach(element => {
            const key = element.getAttribute('data-lang');
            const context = element.getAttribute('data-context');
            if (translations[lang] && translations[lang][context] && translations[lang][context][key]) {
                element.innerText = translations[lang][context][key];
            }
        });
    }

    function populateAppointmentForm(appointment, fillDetails = true) {
        // التحقق من صحة البيانات
        if (!appointment.DATE || !appointment.TIME) {
            console.error("Invalid appointment data:", appointment);
            alert("Invalid appointment details. Please contact support.");
            return;
        }


        // عرض النموذج
        const bookingForm = document.getElementById('booking-form');
        const calendarContainer = document.getElementById('calendar-container');
        const timeSlots = document.getElementById('time-slots');
        const formFields = document.getElementById('form-details'); // حقول الاسم والإيميل

        // bookingForm.style.display = 'block';

        // تعبئة البيانات في النموذج
        document.getElementById('name').value = appointment.NAME;
        const emailField = document.getElementById('email');
        emailField.value = appointment.email;
        emailField.setAttribute('readonly', true); // منع تعديل البريد الإلكتروني

        if (fillDetails) {
            // تحديد اليوم في التقويم
            const targetDate = new Date(appointment.DATE);
            const dayElements = document.querySelectorAll('.day');
            let selectedDay = null;

            dayElements.forEach(day => {
                if (day.innerText.startsWith(targetDate.getDate().toString())) {
                    selectedDay = day;
                }
            });

            if (selectedDay) {
                selectedDay.click(); // محاكاة اختيار اليوم
            } else {
                console.error("Day not found for date:", appointment.DATE);
            }

            // تحديد الوقت في التقويم
            const targetTime = convertTo12HourFormat(appointment.TIME);
            const slotElements = document.querySelectorAll('.slot');
            let selectedSlot = null;

            slotElements.forEach(slot => {
                if (slot.innerText === targetTime) {
                    selectedSlot = slot;
                }
            });

            if (selectedSlot) {
                selectedSlot.click(); // محاكاة اختيار الوقت
            } else {
                console.error("Slot not found for time:", appointment.TIME);
            }


            // العثور على اليوم وتلوينه
            document.querySelectorAll('.day').forEach(day => {
                if (day.innerText.startsWith(targetDate.getDate().toString())) {
                    day.classList.add('user-appointment');
                }
            });

            // العثور على الوقت وتلوينه
            document.querySelectorAll('.slot').forEach(slot => {
                if (slot.innerText === targetTime) {
                    slot.classList.add('user-appointment');
                }
            });
        } else {
            // في حالة Missed وCancelled، لا تعبئة للتاريخ والوقت
            calendarContainer.style.display = 'none';
            timeSlots.style.display = 'none';
            formFields.style.display = 'none';
            document.getElementById('selected-date').innerText = "";
        }
    }

    function updateConfirmedTexts(lang) {
        const titleTranslations = {
            en: "Edit Your Appointment",
            nl: "Wijzig uw afspraak",
            ar: "تعديل موعدك"
        };

        const buttonTranslations = {
            en: "Confirm Appointment Changes",
            nl: "Bevestig afspraakwijzigingen",
            ar: "تأكيد تعديل الحجز"
        };

        const mainTitle = document.querySelector('[data-lang="main-title"]');
        const confirmButton = document.querySelector('[data-lang="confirm-button"]');

        if (mainTitle) mainTitle.innerText = titleTranslations[lang];
        if (confirmButton) confirmButton.innerText = buttonTranslations[lang];
    }

    function convertTo12HourFormat(time24) {
        const [hours, minutes] = time24.split(':').map(Number);
        const period = hours >= 12 ? 'PM' : 'AM';
        const adjustedHours = hours % 12 || 12; // تحويل الساعة 0 إلى 12
        return `${adjustedHours}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    function renewAppointment() {
        const calendarContainer = document.getElementById('calendar-container');
        const timeSlots = document.getElementById('time-slots');
        const bookingForm = document.getElementById('booking-form');
        const formFields = document.getElementById('form-details'); // حقول الاسم والإيميل

        // عرض التقويم لإعادة جدولة الموعد
        calendarContainer.style.display = 'block';
        timeSlots.style.display = 'none';
        formFields.style.display = 'block'; // عرض الحقول

        // إعادة تعيين أي تحديدات سابقة
        document.querySelectorAll('.day').forEach(day => day.classList.remove('selected'));
        document.querySelectorAll('.slot').forEach(slot => slot.classList.remove('selected'));
        document.getElementById('selected-date').innerText = "";
    }